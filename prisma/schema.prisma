generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String    @unique
  password      String
  balance       Int       @default(1000) // virtual coins; new users start with 1000
  loginStreak   Int       @default(0)
  lastLoginDate DateTime?
  winStreak     Int       @default(0)
  xp            Int       @default(0)
  level         Int       @default(1)
  eloRating     Int       @default(1000)
  role          String    @default("user") // "user" | "admin"
  totalTrades   Int       @default(0) // lifetime bet placements
  totalWins     Int       @default(0) // markets resolved in user's favour
  totalLosses   Int       @default(0) // markets resolved against user
  totalProfit   Int       @default(0) // net coins gained/lost from resolved markets
  isBot         Boolean   @default(false)   // true = simulation bot, never a real user
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  marketsCreated     Market[]              @relation("CreatedBy")
  bets               Bet[]
  transactions       Transaction[]
  agent              UserAgent?
  purchases          AgentPurchase[]
  missionProgress    UserMissionProgress[]
  portfolioSnapshots PortfolioSnapshot[]
  comments           Comment[]
  notifications      Notification[]
  settings           UserSettings?
}

model UserMissionProgress {
  id         String    @id @default(cuid())
  userId     String
  missionKey String
  date       String
  progress   Int       @default(0)
  completed  Boolean   @default(false)
  claimedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, missionKey, date])
  @@index([userId])
}

model UserAgent {
  id                  String   @id @default(cuid())
  userId              String   @unique
  gender              String   // "male" | "female"
  equippedHeadwareId  String?
  equippedShirtId     String?
  equippedPantsId     String?
  equippedShoesId     String?
  equippedAccessoryId String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AgentItem {
  id        String   @id @default(cuid())
  category  String   // "headware" | "shirt" | "pants" | "shoes" | "accessories"
  name      String
  price     Int
  gender    String   @default("unisex") // "unisex" | "male" | "female"
  icon      String?  // optional icon/thumbnail url
  color     String?  // optional hex color for display on mannequin (e.g. shirts)
  order     Int      @default(0)
  createdAt DateTime @default(now())

  purchases AgentPurchase[]
}

model AgentPurchase {
  id          String   @id @default(cuid())
  userId      String
  agentItemId String
  purchasedAt DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agentItem AgentItem @relation(fields: [agentItemId], references: [id], onDelete: Cascade)

  @@unique([userId, agentItemId])
  @@index([userId])
}

model Market {
  id                 String    @id @default(cuid())
  title              String
  description        String?
  imageUrl           String?   // optional custom cover image URL
  type               String    // "yes_no" | "multiple_choice"
  category           String    @default("culture") // "sports" | "politics" | "culture" | "crypto" | "tech"
  creatorDeposit     Int       @default(0) // 100 coins deducted at creation, refunded if eligible
  totalVolume        Int       @default(0) // sum of all bet amounts
  participantCount   Int       @default(0) // unique users who placed at least one bet
  resolvedOutcomeId  String?   // set when market is resolved
  currentProbability Float     @default(50) // 1–99, probability of YES outcome (AMM price)
  liquidity          Int       @default(1000) // AMM liquidity parameter; 100-coin bet moves price ~10%
  closesAt           DateTime
  createdAt          DateTime  @default(now())
  createdById        String

  createdBy            User                  @relation("CreatedBy", fields: [createdById], references: [id])
  outcomes             Outcome[]
  bets                 Bet[]
  probabilitySnapshots ProbabilitySnapshot[]
  comments             Comment[]
  notifications        Notification[]

  @@index([closesAt])
  @@index([createdById])
  @@index([category])
}

model Outcome {
  id        String   @id @default(cuid())
  marketId  String
  label     String   // "Yes", "No", or "Option A", etc.
  order     Int      @default(0)

  market               Market                @relation(fields: [marketId], references: [id], onDelete: Cascade)
  bets                 Bet[]
  probabilitySnapshots ProbabilitySnapshot[]

  @@unique([marketId, label])
  @@index([marketId])
}

model Bet {
  id               String    @id @default(cuid())
  userId           String
  marketId         String
  outcomeId        String
  amount           Int       // coins staked
  entryProbability Float?    // probability of CHOSEN outcome at time of bet (1–99 scale)
  shares           Float?    // amount / entryProbability
  closedAt         DateTime? // set on cash-out (early exit)
  exitProbability  Float?    // probability of chosen outcome at cash-out (1–99 scale)
  isBot            Boolean   @default(false) // true = placed by a simulation bot

  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  market  Market  @relation(fields: [marketId], references: [id], onDelete: Cascade)
  outcome Outcome @relation(fields: [outcomeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([marketId])
}

model ProbabilitySnapshot {
  id          String   @id @default(cuid())
  marketId    String
  outcomeId   String
  probability Float    // 0.01–0.99
  recordedAt  DateTime // shared timestamp for all outcomes in one bet batch

  market  Market  @relation(fields: [marketId], references: [id], onDelete: Cascade)
  outcome Outcome @relation(fields: [outcomeId], references: [id], onDelete: Cascade)

  @@index([marketId, recordedAt])
}

model PortfolioSnapshot {
  id         String   @id @default(cuid())
  userId     String
  totalValue Int      // balance + unrealized value of all open positions at snapshot time
  date       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
}

model Transaction {
  id           String   @id @default(cuid())
  userId       String
  type         String   // "initial" | "bet" | "win" | "cashout" | "refund" | "purchase" | "deposit" | "deposit_refund" | "creator_reward"
  amount       Int      // positive = credit, negative = debit (for bet)
  balanceAfter Int?     // snapshot after tx
  referenceId  String?  // bet id or market id

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Comment {
  id        String   @id @default(cuid())
  marketId  String
  userId    String
  username  String   // denormalized — user's display name at time of posting
  content   String   // max 300 chars enforced in application layer
  createdAt DateTime @default(now())

  market Market @relation(fields: [marketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([marketId, createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "MARKET_RESOLVED" | "BET_RESULT"
  message   String
  marketId  String?  // optional nav hint — no FK constraint needed
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  market Market? @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model UserSettings {
  userId                   String  @id
  notifyOnMarketResolution Boolean @default(true)
  notifyOnBetResult        Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Ephemeral global activity log — capped at 200 rows, no FK constraints for simplicity
model Activity {
  id          String   @id @default(cuid())
  type        String   // "TRADE" | "MARKET_RESOLVED"
  userId      String?
  username    String?
  marketId    String
  marketTitle String
  side        String?  // "YES" | "NO" for trades
  amount      Int?
  price       Float?   // probability of chosen side at time of trade (1–99)
  createdAt   DateTime @default(now())

  @@index([createdAt])
}
