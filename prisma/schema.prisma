generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String    @unique
  password      String
  balance       Int       @default(1000) // virtual coins; new users start with 1000
  loginStreak   Int       @default(0)
  lastLoginDate DateTime?
  winStreak     Int       @default(0)
  xp            Int       @default(0)
  level         Int       @default(1)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  marketsCreated  Market[]              @relation("CreatedBy")
  bets            Bet[]
  transactions    Transaction[]
  agent           UserAgent?
  purchases       AgentPurchase[]
  missionProgress UserMissionProgress[]
}

model UserMissionProgress {
  id         String    @id @default(cuid())
  userId     String
  missionKey String
  date       String
  progress   Int       @default(0)
  completed  Boolean   @default(false)
  claimedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, missionKey, date])
  @@index([userId])
}

model UserAgent {
  id                  String   @id @default(cuid())
  userId              String   @unique
  gender              String   // "male" | "female"
  equippedHeadwareId  String?
  equippedShirtId     String?
  equippedPantsId     String?
  equippedShoesId     String?
  equippedAccessoryId String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AgentItem {
  id        String   @id @default(cuid())
  category  String   // "headware" | "shirt" | "pants" | "shoes" | "accessories"
  name      String
  price     Int
  gender    String   @default("unisex") // "unisex" | "male" | "female"
  icon      String?  // optional icon/thumbnail url
  color     String?  // optional hex color for display on mannequin (e.g. shirts)
  order     Int      @default(0)
  createdAt DateTime @default(now())

  purchases AgentPurchase[]
}

model AgentPurchase {
  id          String   @id @default(cuid())
  userId      String
  agentItemId String
  purchasedAt DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agentItem AgentItem @relation(fields: [agentItemId], references: [id], onDelete: Cascade)

  @@unique([userId, agentItemId])
  @@index([userId])
}

model Market {
  id                 String    @id @default(cuid())
  title              String
  description        String?
  type               String    // "yes_no" | "multiple_choice"
  category           String    @default("culture") // "sports" | "politics" | "culture" | "crypto" | "tech"
  creatorDeposit     Int       @default(0) // 100 coins deducted at creation, refunded if eligible
  totalVolume        Int       @default(0) // sum of all bet amounts
  participantCount   Int       @default(0) // unique users who placed at least one bet
  resolvedOutcomeId  String?   // set when market is resolved
  closesAt           DateTime
  createdAt          DateTime  @default(now())
  createdById        String

  createdBy User      @relation("CreatedBy", fields: [createdById], references: [id])
  outcomes  Outcome[]
  bets      Bet[]

  @@index([closesAt])
  @@index([createdById])
  @@index([category])
}

model Outcome {
  id        String   @id @default(cuid())
  marketId  String
  label     String   // "Yes", "No", or "Option A", etc.
  order     Int      @default(0)

  market Market @relation(fields: [marketId], references: [id], onDelete: Cascade)
  bets   Bet[]

  @@unique([marketId, label])
  @@index([marketId])
}

model Bet {
  id        String   @id @default(cuid())
  userId    String
  marketId  String
  outcomeId String
  amount    Int      // coins staked

  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  market  Market  @relation(fields: [marketId], references: [id], onDelete: Cascade)
  outcome Outcome @relation(fields: [outcomeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([marketId])
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  type        String   // "initial" | "bet" | "win" | "refund" | "purchase" | "deposit" | "deposit_refund" | "creator_reward"
  amount      Int      // positive = credit, negative = debit (for bet)
  balanceAfter Int?    // snapshot after tx
  referenceId String?  // bet id or market id

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
